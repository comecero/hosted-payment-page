/*
Comecero Hosted Payment Page version: ï»¿1.0.0
https://comecero.com
https://github.com/comecero/cart
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.controller("MainController",["$scope","SettingsService","CurrencyService",function(e,t,a){e.settings=t.get(),e.currency=a.getCurrencyName()}]),app.controller("PayController",["$scope","$location","PaymentService","GeoService","CurrencyService","SettingsService","HelperService","StorageService","$document",function(e,t,a,r,n,o,c,i,p){e.data={},e.geoService=r,e.settings=o.get(),e.helpers=c,e.data.payment={customer:{billing_address:{country:null}},payment_method:{}},e.data.shipping_is_billing=!0,e.data.payment_method={},e.data.referenceEditable=!1,e.data.descriptionEditable=!1,e.data.card={type:"credit_card"},e.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/pay"}},e.settings.app.reference_required&&!e.settings.app.reference_required.show_reference&&(e.settings.app.reference_required=!1),a.getOptions().then(function(r){e.data.options=r;var o;i.get("hpp_payment")&&(o=JSON.parse(i.get("hpp_payment"))),e.data.countries=[],_.each(r.allowed_customer_countries,function(t){var a=_.findWhere(e.geoService.getData().countries,{code:t});a&&e.data.countries.push(a)}),e.data.countries=_.sortBy(e.data.countries,"name"),e.data.payment.customer.billing_address.country=r.customer_default_country,e.data.payment.currency=r.customer_default_currency,n.setCurrency(r.customer_default_currency),t.search().reference||(e.data.referenceEditable=!0),t.search().description||(e.data.descriptionEditable=!0),e.data.payment=a.fromParams(e.data.payment,t),e.data.payment.total||e.data.payment.subtotal||e.data.payment.shipping||(o&&(e.data.payment.currency=o.currency||r.customer_default_currency,o.total?e.data.payment.total=o.total:(e.data.payment.subtotal=o.subtotal,e.data.payment.shipping=o.shipping,e.data.payment.tax=o.tax)),e.data.payment.currency=e.data.payment.currency||r.customer_default_currency,n.setCurrency(e.data.payment.currency)),!e.data.payment.reference&&o&&o.reference&&(e.data.payment.reference=o.reference,e.data.referenceEditable=!1),!e.data.payment.description&&o&&o.description&&(e.data.payment.description=o.description,e.data.descriptionEditable=!1),e.data.payment.total&&(e.data.payment.total=utils.cleanPrice(e.data.payment.total)),i.set("hpp_payment",JSON.stringify({currency:e.data.payment.currency,total:e.data.payment.total,subtotal:e.data.payment.subtotal,shipping:e.data.payment.shipping,tax:e.data.payment.tax,reference:e.data.payment.reference,description:e.data.payment.description}),3600)},function(t){e.data.error=t}),e.calculateTotal=function(e){var t=e.subtotal||0,a=e.shipping||0,r=e.tax||0;return Number(t)+Number(a)+Number(r)||e.total},e.onPaymentSuccess=function(e){switch(e.payment_method.type){case"paypal":window.location=e.response_data.redirect_url;break;default:t.path("/receipt/"+e.payment_id)}},e.$watch("data.error",function(t,a){e.data.error&&p.scrollTop(0,500)})}]),app.controller("ReceiptController",["$scope","$routeParams","PaymentService","OrderService","SettingsService","HelperService","StorageService","$document",function(e,t,a,r,n,o,c,i){e.data={},e.helpers=o,e.data.params={},e.data.params.expand="payment_method,payment_method.data,customer",e.data.params.formatted=!0,e.settings=n.get(),e.data.params.options=!0,e.data.params.formatted=!0,e.customer={},a.get(t.id,e.data.params).then(function(t){e.data.payment=t,c.remove("hpp_payment")},function(t){e.data.error=t}),a.getOptions().then(function(t){e.options=t},function(t){e.data.error=t}),e.$watch("data.error",function(t,a){e.data.error&&i.scrollTop(0,500)})}]),app.controller("PaymentController",["$scope","$location","$routeParams","CartService","PaymentService","SettingsService","HelperService","GeoService","$document",function(e,t,a,r,n,o,c,i,p){e.data={},e.options={};t.search();e.data.payment_id=a.id,e.data.payment_id||t.path("/cart"),e.settings=o.get(),e.helpers=c,e.geoService=i,e.data.params={},e.data.params.expand="payment_method,payment_method.data,customer",n.get(e.data.payment_id,e.data.params).then(function(a){e.data.payment=a,e.data.paymentOrig=angular.copy(a),"completed"==a.status&&t.path("/receipt/"+a.payment_id),n.getOptions().then(function(t){c.isRequiredCustomerField("company_name",t)&&null==e.data.sale.customer.company_name&&(e.options.showCompanyName=!0),c.isRequiredCustomerField("phone",t)&&null==e.data.sale.customer.phone&&(e.options.showPhone=!0)},function(t){e.data.error=t})},function(t){e.data.error=t}),e.onPaymentSuccess=function(a){var r=function(e){"initiated"==e.status?window.location.replace(e.response_data.redirect_url):t.path("/receipt/"+e.payment_id)};n.update(e.data.payment).then(function(e){r(e)},function(e){r(a)})},e.$watch("data.error",function(t,a){e.data.error&&p.scrollTop(0,500)})}]);