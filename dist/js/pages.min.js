/*
Comecero Hosted Payment Page version: ï»¿1.0.2
https://comecero.com
https://github.com/comecero/cart
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.controller("LinkController",["$scope","$location","PaymentService","StorageService",function(e,t,a,n){var r=a.fromParams({},t);n.set("hpp_payment",JSON.stringify(r),21600),t.search({}),t.path("/pay"),t.replace()}]),app.controller("MainController",["$scope","SettingsService","CurrencyService",function(e,t,a){e.settings=t.get(),e.currency=a.getCurrencyName()}]),app.controller("PayController",["$scope","$location","PaymentService","GeoService","CurrencyService","SettingsService","HelperService","StorageService","$document",function(e,t,a,n,r,o,i,c,d){e.data={},e.geoService=n,e.settings=o.get(),e.helpers=i,e.data.payment={customer:{billing_address:{country:null}},payment_method:{}},e.data.shipping_is_billing=!0,e.data.payment_method={},e.data.referenceEditable=!1,e.data.descriptionEditable=!1,e.data.payment_method={type:"credit_card"},e.data.paypal={type:"paypal",data:{success_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/review/{{payment_id}}",cancel_url:window.location.href.substring(0,window.location.href.indexOf("#"))+"#/pay"}},e.settings.app.reference_required&&!e.settings.app.show_reference&&(e.settings.app.reference_required=!1),a.getOptions().then(function(t){e.data.options=t;var a=e.data.payment;c.get("hpp_payment")&&(a=JSON.parse(c.get("hpp_payment"))),e.data.countries=[],_.each(t.allowed_customer_countries,function(t){var a=_.findWhere(e.geoService.getData().countries,{code:t});a&&e.data.countries.push(a)}),e.data.countries=_.sortBy(e.data.countries,"name"),e.data.payment.customer.billing_address.country=t.customer_default_country,a.reference||(e.data.referenceEditable=!0),a.description||(e.data.descriptionEditable=!0),e.data.payment=a,e.data.payment.currency=e.data.payment.currency||t.customer_default_currency,r.setCurrency(e.data.payment.currency),e.data.payment.total&&(e.data.payment.total=utils.cleanPrice(e.data.payment.total))},function(t){e.data.error=t}),e.calculateTotal=function(e){var t=e.subtotal||0,a=e.shipping||0,n=e.tax||0;return Number(t)+Number(a)+Number(n)||e.total},e.onPaymentSuccess=function(e){"paypal"==e.payment_method.type&&"initiated"==e.status?window.location=e.response_data.redirect_url:t.path("/receipt/"+e.payment_id)},e.setPaymentMethod=function(t,a){e.data.payment_method={},t&&(e.data.payment_method.payment_method_id=t),a&&(e.data.payment_method.type=a)},e.onSignOut=function(){e.data.payment_method&&(e.data.payment_method.payment_method_id=null,e.data.payment_method.type="credit_card")},e.$watch("data.error",function(t,a){e.data.error&&d.scrollTop(0,500)})}]),app.controller("ReceiptController",["$scope","$routeParams","PaymentService","OrderService","SettingsService","HelperService","StorageService","$document",function(e,t,a,n,r,o,i,c){e.data={},e.helpers=o,e.data.params={},e.data.params.expand="payment_method,payment_method.data,customer",e.data.params.formatted=!0,e.settings=r.get(),e.data.params.options=!0,e.data.params.formatted=!0,e.customer={},a.get(t.id,e.data.params).then(function(t){e.data.payment=t,i.remove("hpp_payment")},function(t){e.data.error=t}),a.getOptions().then(function(t){e.options=t},function(t){e.data.error=t}),e.$watch("data.error",function(t,a){e.data.error&&c.scrollTop(0,500)})}]),app.controller("PaymentController",["$scope","$location","$routeParams","CartService","PaymentService","SettingsService","HelperService","GeoService","$document",function(e,t,a,n,r,o,i,c,d){e.data={},e.options={};t.search();e.data.payment_id=a.id,e.data.payment_id||t.path("/cart"),e.settings=o.get(),e.helpers=i,e.geoService=c,e.data.params={},e.data.params.expand="payment_method,payment_method.data,customer",r.get(e.data.payment_id,e.data.params).then(function(a){e.data.payment=a,e.data.paymentOrig=angular.copy(a),"completed"==a.status&&t.path("/receipt/"+a.payment_id),r.getOptions().then(function(t){i.isRequiredCustomerField("company_name",t)&&null==e.data.sale.customer.company_name&&(e.options.showCompanyName=!0),i.isRequiredCustomerField("phone",t)&&null==e.data.sale.customer.phone&&(e.options.showPhone=!0)},function(t){e.data.error=t})},function(t){e.data.error=t}),e.onPaymentSuccess=function(a){var n=function(e){"initiated"==e.status?window.location.replace(e.response_data.redirect_url):t.path("/receipt/"+e.payment_id)};r.update(e.data.payment).then(function(e){n(e)},function(e){n(a)})},e.$watch("data.error",function(t,a){e.data.error&&d.scrollTop(0,500)})}]);